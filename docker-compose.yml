services:
  # Redis for Pub/Sub and State Store
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - dapr-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 1s
      timeout: 3s
      retries: 30
      start_period: 5s

  # Dapr Placement service (for actors, but needed for Dapr runtime)
  dapr-placement:
    image: "daprio/dapr:latest"
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"
      - "6050:6050"
    networks:
      - dapr-network

  # Zipkin for distributed tracing observability
  zipkin:
    image: openzipkin/zipkin:latest
    ports:
      - "9411:9411"
    networks:
      - dapr-network

  # ADS-B Feeder Service
  adsb-feeder:
    build:
      context: ./services/adsb-feeder
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - MOCK_MODE=true
      - PORT=3000
      - DAPR_HTTP_PORT=3500
      - DAPR_HOST=0.0.0.0
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    networks:
      - dapr-network

  # Dapr sidecar for adsb-feeder
  # Uses network_mode to share network with app container
  adsb-feeder-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "adsb-feeder",
      "-app-port", "3000",
      "-dapr-http-port", "3500",
      "-dapr-grpc-port", "50001",
      "-components-path", "/components",
      "-config", "/config/config.yaml",
      "-placement-host-address", "dapr-placement:50006"
    ]
    volumes:
      - ./components:/components
      - ./config.yaml:/config/config.yaml:ro
      - ./secrets:/secrets:ro
      - data-volume:/data
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      adsb-feeder:
        condition: service_started
    network_mode: "service:adsb-feeder"

  # Fleet Stats Service
  fleet-stats:
    build:
      context: ./services/fleet-stats
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - DAPR_HTTP_PORT=3501
      - DAPR_HOST=0.0.0.0
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    networks:
      - dapr-network

  # Dapr sidecar for fleet-stats
  # Uses network_mode to share network with app container
  fleet-stats-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "fleet-stats",
      "-app-port", "3001",
      "-dapr-http-port", "3501",
      "-dapr-grpc-port", "50002",
      "-components-path", "/components",
      "-config", "/config/config.yaml",
      "-placement-host-address", "dapr-placement:50006"
    ]
    volumes:
      - ./components:/components
      - ./config.yaml:/config/config.yaml:ro
      - ./secrets:/secrets:ro
      - data-volume:/data
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      fleet-stats:
        condition: service_started
    network_mode: "service:fleet-stats"

  # Flight Dashboard Service
  flight-dashboard:
    build:
      context: ./services/flight-dashboard
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
      - "3502:3502"  # Expose Dapr HTTP port for sidecar communication
    environment:
      - PORT=3002
      - DAPR_HTTP_PORT=3502
      - DAPR_HOST=0.0.0.0
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    networks:
      - dapr-network

  # Dapr sidecar for flight-dashboard
  # Uses network_mode to share network with app container
  flight-dashboard-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "flight-dashboard",
      "-app-port", "3002",
      "-dapr-http-port", "3502",
      "-dapr-grpc-port", "50003",
      "-components-path", "/components",
      "-config", "/config/config.yaml",
      "-placement-host-address", "dapr-placement:50006"
    ]
    volumes:
      - ./components:/components
      - ./config.yaml:/config/config.yaml:ro
      - ./secrets:/secrets:ro
      - data-volume:/data
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      flight-dashboard:
        condition: service_started
    network_mode: "service:flight-dashboard"

  # Airport Tracker Service (Go)
  airport-tracker:
    build:
      context: ./services/airport-tracker
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
      - "3503:3503"  # Expose Dapr HTTP port for sidecar communication
    environment:
      - PORT=3003
      - DAPR_HTTP_PORT=3503
      - DAPR_HOST=0.0.0.0
      - AIRPORT_CONFIG_PATH=/config/airports.json
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    networks:
      - dapr-network
    volumes:
      - ./services/airport-tracker/config:/config:ro

  # Dapr sidecar for airport-tracker
  # Uses network_mode to share network with app container
  airport-tracker-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "airport-tracker",
      "-app-port", "3003",
      "-dapr-http-port", "3503",
      "-dapr-grpc-port", "50004",
      "-components-path", "/components",
      "-config", "/config/config.yaml",
      "-placement-host-address", "dapr-placement:50006"
    ]
    volumes:
      - ./components:/components
      - ./config.yaml:/config/config.yaml:ro
      - ./secrets:/secrets:ro
      - data-volume:/data
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      airport-tracker:
        condition: service_started
    network_mode: "service:airport-tracker"

  # Flight Archiver Service (Python)
  flight-archiver:
    build:
      context: ./services/flight-archiver
      dockerfile: Dockerfile
    ports:
      - "3004:3004"
      - "3504:3504"  # Expose Dapr HTTP port for sidecar communication
    environment:
      - PORT=3004
      - DAPR_HTTP_PORT=3504
      - DAPR_HOST=0.0.0.0
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
    networks:
      - dapr-network

  # Dapr sidecar for flight-archiver
  # Uses network_mode to share network with app container
  flight-archiver-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "flight-archiver",
      "-app-port", "3004",
      "-dapr-http-port", "3504",
      "-dapr-grpc-port", "50005",
      "-components-path", "/components",
      "-config", "/config/config.yaml",
      "-placement-host-address", "dapr-placement:50006"
    ]
    volumes:
      - ./components:/components
      - ./config.yaml:/config/config.yaml:ro
      - ./secrets:/secrets:ro
      - data-volume:/data
    depends_on:
      redis:
        condition: service_healthy
      dapr-placement:
        condition: service_started
      flight-archiver:
        condition: service_started
    network_mode: "service:flight-archiver"

volumes:
  redis-data:
  data-volume:

networks:
  dapr-network:
    driver: bridge

